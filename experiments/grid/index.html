<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="utf-8">
	<title>HdM Sammelkrake</title>
	<style>
		html, body { margin: 0; padding: 0; font-family: sans-serif; font-size: small; }
		header { margin: 0; padding: 0.75em; color: hsl(0, 0%, 95%); background: hsl(0, 0%, 25%); }
		header a { color: inherit; }
		header h1, header p { margin: 0; padding: 0; }
		
		ul { margin: 0; padding: 0; list-style: none; border: 1px solid red; position: relative; background: url('grid.png'); }
		ul > li { display: none; }
		ul > div { position: absolute; width: 100px; height: 100px; box-sizing: border-box; padding: 10px; text-align: center; }
		/*
		ul li { position: absolute; width: 90px; height: 90px; margin: 5px; opacity: 0.25; border-radius: 10px; }
		ul li.a { background-color: green; }
		ul li.b { background-color: blue; }
		*/
	</style>
	<script src="jquery-1.7.2.js"></script>
	<script>
		
		jQuery.fn.grid = function(options){
			var opts = jQuery.extend({
				'cell-width': 100,
				'cell-height': 100,
				'cell-spacing': 10,
				weights: { edge: 0.25, left: 1, right: 1, top: 0.5, bottom: 0.5 }
			});
			var context = this;
			
			var cells = [];
			var grid_width = 0, grid_height = 0;
			
			// Returns the grid value for the specified cell
			var at = function(x, y){
				return cells[y * grid_width + x];
			};
			
			// Increments the value at the specified cell if it contains nothing (undefined)
			// or a number. In any other case (e.g. string IDs) the cell is left unchanged.
			var inc_at = function(x, y, val){
				if (x < 0 || x > grid_width - 1 || y < 0 )
					return;
				var weight = at(x, y);
				if ( typeof weight == 'undefined' )
					weight = val;
				else if ( typeof weight == 'number' )
					weight += val;
				cells[y * grid_width + x] = weight;
			};
			
			// Sets the value for each cell in the specified rectangle
			var set_rect = function(x, y, w, h, val){
				if (x < 0) x = 0;
				if (y < 0) y = 0;
				if (x + w > grid_width) w = grid_width - x;
				
				for(var i = 0; i < w; i++){
					for(var j = 0; j < h; j++){
						cells[(y+j) * grid_width + (x+i)] = val;
					}
				}
			};
			
			// Searches a free rectangle near these x and y coords.
			var refine_pos = function(x, y, w, h){
				var check_rect = function(x1, y1, x2, y2){
					if (x1 < 0 || y1 < 0 || x2 >= grid_width)
						return false;
					
					for(var x = x1; x <= x2; x++){
						for(var y = y1; y <= y2; y++){
							var type = typeof at(x, y);
							if ( x >= grid_width || !(type == 'number' || type == 'undefined') )
								return false;
						}
					}
					return true;
				};
				
				var dx = w-1, dy = h-1;
				if ( check_rect(x-dx, y-dy, x, y) )
					return {x: x-dx, y: y-dy};
				else if ( check_rect(x-dx, y, x, y+dy) )
					return {x: x-dx, y: y};
				else if ( check_rect(x, y-dy, x+dx, y) )
					return {x: x, y: y-dy};
				else if ( check_rect(x, y, x+dx, y+dy) )
					return {x: x, y: y};
				return false;
			};
			
			// Updates the weights around the rectangle. You can configure the
			// weights via the `weights` variable above.
			var update_weights = function(x, y, w, h){
				inc_at(x - 1, y - 1, opts.weights.edge);
				inc_at(x + w, y - 1, opts.weights.edge);
				inc_at(x + w, y + h, opts.weights.edge);
				inc_at(x - 1, y + h, opts.weights.edge);
				
				for(var i = x; i < x + w; i++){
					inc_at(i, y - 1, opts.weights.top);
					inc_at(i, y + h, opts.weights.bottom);
				}
				
				for(var i = y; i < y + h; i++){
					inc_at(x - 1, i, opts.weights.left);
					inc_at(x + w, i, opts.weights.right);
				}
			};
			
			// Inserts a new box into the grid
			var insert = function(id, width, height){
				if ( at(0, 0) == undefined ) {
					var coords = refine_pos(0, 0, width, height);
					update_weights(0, 0, width, height);
					set_rect(coords.x, coords.y, width, height, id);
					grid_height = height;
					return {x: 0, y: 0};
				} else {
					var sorted_cells = [];
					for(var i = 0; i < cells.length; i++)
						sorted_cells.push({x: i % grid_width, y: Math.floor(i / grid_width), val: cells[i]});
					
					sorted_cells.sort(function(a, b){
						if (typeof a.val == 'number') {
							if (typeof b.val == 'number')
								return (a.val == b.val) ? 0 : ( (a.val < b.val) ? 1 : -1 );
							else
								return -1;
						} else {
							return (typeof b.val == 'number') ? 1 : 0;
						}
					});
					
					for(var i = 0; i < sorted_cells.length; i++){
						var coords = refine_pos(sorted_cells[i].x, sorted_cells[i].y, width, height);
						if (coords != false){
							update_weights(coords.x, coords.y, width, height);
							set_rect(coords.x, coords.y, width, height, id);
							grid_height = Math.max(grid_height, coords.y + height);
							return {x: coords.x, y: coords.y};
						}
					}
				}
			};
			
			this.on('layout', function(){
				grid_width = Math.floor(context.innerWidth() / opts['cell-width'] );
				context.children().each(function(){
					var elem = $(this);
					insert(elem.attr('id'), elem.data('width'), elem.data('height'));
					context.triggerHandler('debug');
				});
				context.css('min-height', grid_height * opts['cell-height'] + 'px');
				return false;
			});
			
			this.on('debug', function(){
				context.children().hide().find('> div.grid-debug').remove();
				for(var i = 0; i < cells.length; i++){
					var x = i % grid_width, y = Math.floor(i / grid_width);
					$('<div class="grid-debug">').text(cells[i]).css({left: x * opts['cell-width'] +  'px', top: y * opts['cell-height'] + 'px'}).appendTo(context);
				}
				return false;
			});
			
			this.triggerHandler('layout');
			return this;
		};
		
		$(document).ready(function(){
			$('ul').grid();
		});
	</script>
</head>
<body>

<header>
	<h1><a href="/">HdM Sammelkrake</a></h1>
	<p>Alle studienrelevanten Infos auf einem Blick</p>
</header>

<ul>
	<li id="asd" data-width="2" data-height="1"></li>
	<li id="wer" data-width="3" data-height="2"></li>
	<li id="rtz" data-width="2" data-height="1"></li>
	<li id="ztj" data-width="2" data-height="1"></li>
	<li id="ghj" data-width="2" data-height="1"></li>
	<li id="uio" data-width="2" data-height="1"></li>
	<li id="ycd" data-width="2" data-height="1"></li>
	<li id="ziz" data-width="2" data-height="1"></li>
	<li id="nmk" data-width="2" data-height="1"></li>
	<li id="nmk" data-width="2" data-height="4"></li>
</ul>

</body>
</html>